## ðŸ§© What Is KVM?

**KVM = Kernel-based [^1][Virtual Machine**]([What is a virtual machine (VM)?](https://www.redhat.com/en/topics/virtualization/what-is-a-virtual-machine))

Itâ€™s a **virtualization technology** built into the Linux kernel that turns it into a **hypervisor**.

### ðŸ”‘ In simple terms:

> KVM is like a plugin inside Linux that allows you to run full virtual machines (Windows, Linux, etc.) **as if they were real computers**, using your real CPU and memory.
> 
> Hypervisors need operating system-level componentsâ€”such as a memory manager, process scheduler, input/output (I/O) stack, device drivers, security manager, a network stack, and moreâ€”to run VMs. KVM has all these components because itâ€™s part of the Linux kernel

Itâ€™s used in **cloud platforms** like AWS, GCP, Proxmox, etc.
## What are the features of KVM?

With KVM, a VM is a Linux process, scheduled and managed by the kernel.
KVM also brings features related to security, storage, hardware support, and live migration.
1. Security boundaries with SELinux and sVirt
2. Storage flexibility
	1. KVM is able to use any storage supported by Linux, including some local disks andÂ [network-attached storage (NAS)](https://www.redhat.com/en/topics/data-storage/network-attached-storage).
	2. KVM also supports shared file systems so VM images may be shared by multiple hosts.
3. Live migration
	1. the ability to move a running VM between physical hosts with no noticeable service interruption.
## ðŸ“¦ KVM Architecture Overview

### ðŸ‘‡ KVM has 3 core parts:

+--------------------------+
|        Linux OS                  |
| +--------------------+     |
| |  KVM Module        |      |   â† Controls virtualization at the kernel level
| +--------------------+     |
| +--------------------+     |
| |  QEMU User Space   |   |  â† Emulates devices, BIOS, disks, etc.
| +--------------------+     |
+--------------------------+


Letâ€™s break it down fully:
## âš™ï¸ 1. KVM Kernel Module (Core Engine)

### ðŸ“Œ What it does:

- Provides access to **hardware virtualization** extensions in your CPU:
    
    - Intel â†’ **VT-x**
        
    - AMD â†’ **AMD-V**
        

This lets the OS **create isolated virtual environments** â€” VMs.

> It basically tells the CPU:  
> _â€œHey, allow me to run guest OSes just like the host OS.â€_

### ðŸ”§ How?

- Linux loads the module `kvm.ko` (or `kvm_intel.ko`, `kvm_amd.ko`)
    
- This gives access to `ioctl` system calls that user-space tools (like QEMU) use to create/manage VMs
    
### ðŸ§  Example:

`lsmod | grep kvm`

Shows if KVM is running.

---

## ðŸ§° 2. QEMU (User-space Tool)

KVM alone **can't create or run a VM** by itself â€” itâ€™s just a kernel feature.  
So we use **QEMU** to:

- Emulate BIOS
    
- Emulate devices (disk, network)
    
- Provide console access
    
- Create VM images
    

> QEMU is the **manager/creator**, and KVM is the **executor** using hardware.

### ðŸ§  Example:

`qemu-system-x86_64 -enable-kvm -m 2G -hda ubuntu.img`

This command uses:

- `-enable-kvm` â†’ enables hardware virtualization
    
- `-m 2G` â†’ gives 2GB RAM to VM
    
- `-hda` â†’ uses `ubuntu.img` as the disk
    

---

## ðŸ§± 3. libvirt (Management Layer - Optional)
#### libvirt and virsh

The libvirt project provides an API for managing virtualization platforms. Within libvirt,Â [virsh](https://www.libvirt.org/manpages/virsh.html)Â is a command-line utility for creating, starting, listing, and stopping VMs, as well as entering a virtualization shell.

ðŸ› ï¸ **libvirt kaise kaam karta hai?**

1. **libvirt daemon (`libvirtd`)** background mein chalta hai aur virtualization platform se baat karta hai.
2. Aap **CLI tools** (jaise `virsh`) ya **GUI tools** (jaise `virt-manager`) ka use karke libvirt ko commands bhejte ho.
3. libvirt APIs un commands ko hypervisor tak pahunchata hai, jahan actual VM create ya manage hoti hai.

This is a **high-level API** to manage VMs with tools like `virt-manager`, `virsh`, or Proxmox.

- Think of `libvirt` as the **controller or middleware between virtualization software and CLI tool(virsh). 
    
- It connects to KVM + QEMU and manages VM lifecycle (start, stop, snapshot, etc.)
    

You donâ€™t _need_ libvirt to run KVM, but it's widely used.

---

## âš™ï¸ How KVM Actually Works Internally

Letâ€™s say you want to run a Linux VM:

### ðŸ”„ Step-by-step internal flow:

1. **QEMU calls KVM** and says:  
    â€œI want to create a new VM with X CPU, Y RAM, and disk file `ubuntu.img`.â€
    
2. **KVM module** talks to your CPU using **VT-x or AMD-V**:
    
    - It sets up **VMCS** (Virtual Machine Control Structure) â†’ a table that tells the CPU what to do when running this VM.
        
3. **QEMU emulates BIOS + disk + network**:
    
    - When the guest OS boots, QEMU pretends to be the motherboard, hard drive, etc.
        
4. **The guest OS thinks itâ€™s on a real machine**:
    
    - It runs its own kernel, processes, memory space.
        
5. **CPU switches modes**:
    
    - Uses special "guest mode" (Ring -1) â†’ lower than kernel (Ring 0)
        
    - This is called **VMX root mode** or **SVM**
        
6. **IO requests (disk, network) go back to QEMU**:
    
    - KVM handles CPU/memory
        
    - QEMU handles devices

---

## ðŸ§  Key Terms Explained (with Real Examples)

| Term                 | Meaning                                | Example                      |
| -------------------- | -------------------------------------- | ---------------------------- |
| **VM**               | A fake machine created in software     | Ubuntu inside VirtualBox     |
| **Hypervisor**       | Software that runs VMs                 | KVM is a Type-1 hypervisor   |
| **KVM**              | Kernel module to enable virtualization | Runs Linux VMs with QEMU     |
| **QEMU**             | Emulates hardware                      | Loads ISO, boots OS          |
| **libvirt**          | Management tool                        | `virsh list`, `virt-manager` |
| **VMCS**             | CPU data for guest OS                  | Controls what VM can access  |
| **VT-x / AMD-V**     | CPU virtualization extensions          | Enabled in BIOS              |
| **Guest OS**         | OS running inside VM                   | Windows 10 inside KVM        |
| **Host OS**          | Your actual OS                         | Ubuntu running KVM           |
| **Ring -1 / Ring 0** | CPU privilege levels                   | VM runs in Ring -1           |

---

## ðŸŽ¯ Real-World Example

Letâ€™s say you launch an EC2 instance on AWS.

Hereâ€™s what happens behind the scenes:

1. AWS hardware runs a Linux OS with **KVM** enabled.
    
2. AWS uses its custom version of **QEMU** to create VMs.
    
3. When you launch EC2 (say, Ubuntu t2.micro):
    
    - KVM allocates 1 vCPU, 1GB RAM
        
    - AMI image is loaded into virtual disk
        
    - Guest OS (Ubuntu) boots inside the VM
        
4. You get a public IP and log in via SSH â€” but the VM is running **inside KVM**, on real hardware.
    

---

## ðŸ› ï¸ Can You Use KVM Yourself?

Yes. On a Linux machine, just install:

`sudo apt install qemu-kvm libvirt-daemon-system virt-manager`

Then create a VM using:

`virt-manager`

GUI-based VM creation.

---

## âœ… Final Summary

> **KVM** = Linux kernel module that turns your machine into a hypervisor  
> **QEMU** = Tool that creates and manages VMs  
> **libvirt** = Controller to help manage VMs easily

Together, they make your Linux box capable of running full virtual machines â€” fast, efficiently, and hardware-accelerated.

